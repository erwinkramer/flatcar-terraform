# Flatcar Provisioning Automation for Scaleway

This repository provides tools to automate Flatcar provisioning on [ScaleWay][scaleway] using [Terraform][terraform].

## Features

- Minimal configuration required (demo deployment works with default settings w/o any customisation, just run `terraform apply`!).
- Deploy one or multiple servers.
- Per-server custom configuration via separate [Butane][butane] configuration.

## Prerequisites

1. Scaleway credentials: `access_key`, `secret_key`, `project_id`, `organization_id`, `region` and `zone`.

## HowTo

This will create a server in 'fr-par-1' using a small instance size.
See "Customisation" below for advanced settings.

1. Clone the repo.
2. Add credentials in a `terraform.tfvars` file, expected credentials name can be found in `provider.tf`
3. Run
   ```shell
   terraform init
   ```
4. Edit [`server1.yaml`][server-1] and provide your own custom provisioning configuration in [Butane][butane] syntax.
5. Plan and apply.
   Invoke Terraform:
   ```shell
   terraform plan
   terraform apply
   ```

Terraform will print server information (name, ipv4 and v6) after deployment concluded.

_NOTE_:
* Server IP address can be found at any moment after deployment by running `terraform output`
* If you update server configuration(s) in `server-configs` and re-run `terraform apply`, the instance will be **replaced**.
Consider adding [`create_before_destroy`](https://www.terraform.io/docs/configuration/meta-arguments/lifecycle.html#syntax-and-arguments) to the `scaleway_instance_server` resource in [`compute.tf`](compute.tf) to avoid services becoming unavailable during reprovisioning.

### Customisation

The provisioning automation can be customised via settings in [`terraform.tfvars`][terraform.tfvars]:
  - `cluster_name`: Descriptive name of your cluster, will be used to generate server names.
    `flatcar-terraform` by default.
  - `machines`: Add more machines to your deployment.
    Each machine name must be unique and requires a respective `[NAME].yaml` server configuration in [`server-configs`](server-configs).
    An example / default configuration for machine `server1` is provided with [`server1.yaml`](server-configs/server1.yaml).
    During provisioning, server names are generated by concatenating the cluster name and the machine name - the defaults above will create a single server named `flatcar-terraform-server1`.
  - `ssh_keys`: Additional SSH public keys to add to core user's `authorized_keys`.
    Note that during provisioning, a provisioning RSA key pair will be generated and stored in the local directory `.ssh/provisioning_private_key.pem` and `.ssh/provisioning_key.pub`, respectively.
    The private key can be used for ssh connections (`core` user) to all provisioned servers.
  - `release_channel`: Select one of "lts", "stable", "beta", or "alpha".
    Read more about channels [here](https://www.flatcar.org/releases).
  - `flatcar_version`: Select the desired Flatcar version for the given channel (default to "current", which is the latest).
  - `type`: The spec of the machine, it default to DEV1-S.
  - `flatcar_file`: The local Flatcar Scaleway image to upload as a snapshot.

[butane]: https://www.flatcar.org/docs/latest/provisioning/config-transpiler/configuration/
[server-1]: server-configs/server1.yaml
[scaleway]: https://www.scaleway.com/
[terraform]: https://www.terraform.io/
[terraform-tfvars]: terraform.tfvars
